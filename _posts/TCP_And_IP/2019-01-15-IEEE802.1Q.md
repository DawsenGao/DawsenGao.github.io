---
layout: post
title: 802.1Q协议Tagged、Untagged的理解
description:
category: TCP_And_IP
---
# 1. IEEE802.1Q

Tag为IEEE802.1Q协议定义的VLAN的标记在数据帧中的标示；

## 1.1 IEEE802.1Q协议的定理：

1. 下面是定义的各种端口类型对各种数据帧的处理方法；
   in=进交换器    out=出交换机![数据帧的处理方法](./images/2019-01-15-IEEE802.1Q/数据帧的处理方法.jpg)

2. 所谓的Untagged Port和Tagged Port不是讲述物理端口的状态，而是将是物理端口所拥有的某一个VID的状态，所以一个物理端口可以在某一个VID上是Untagged Port，在另一个VID上是Tagged Port；

3. 一个物理端口只能拥有一个PVID，当一个物理端口拥有了一个PVID的时候，必定会拥有和PVID的TAG等同的VID，而且在这个VID上，这个物理端口必定是Untagged Port；

4. PVID的作用只是在交换机从外部接受到可以接受Untagged数据帧的时候给数据帧添加TAG标记用的，在交换机内部转发数据的时候PVID不起任何作用；

5. 拥有和TAG标记一致的VID的物理端口，不论是否在这个VID上是Untagged Port或者Tagged Port，都可以接受来自交换机内部的标记了这个TAG标记的tagged数据帧；

6. 拥有和TAG标记一致的VID的物理端口，只有在这个VID上是Tagged Port，才可以接受来自交换机外部的标记了这个TAG标记的Tagged数据帧；

Untag就是普通的ethernet报文，普通PC机的网卡是可以识别这样的报文进行通讯；

Tag报文结构的变化是在源mac地址和目的mac地址之后，加上了4bytes的vlan信息，也就是vlan tag头；一般来说这样的报文普通PC机的网卡是不能识别的。

下图说明了802.1Q封装tag报文帧结构

![802.1Q封装tag报文帧结构](./images/2019-01-15-IEEE802.1Q/802.1Q封装tag报文帧结构.jpg)

带802.1Q的帧是在标准以太网帧上插入了4个字节的标识。其中包含：

2个字节的协议标识符（TPID)，当前置0x8100的固定值，表明该帧带有802.1Q的标记信息。2个字节的标记控制信息（TCI），包含了三个域。

Priority域，占3bits，表示报文的优先级，取值0到7，7为最高优先级，0为最低优先级。
规范格式指示符（CFI)域，占1bit，0表示规范格式，应用于以太网；1表示非规范格式，应用于Token Ring。

VLAN ID域，占12bit，用于标示VLAN的归属。

## 1.2 以太网端口有三种链路类型：Access、Hybrid和Trunk。

- Access类型的端口只能属于1个VLAN，一般用于连接计算机的端口；
- Trunk类型的端口可以允许多个VLAN通过，可以接收和发送多个VLAN的报文，一般用于交换机之间连接的端口；
- Hybrid类型的端口可以允许多个VLAN通过，可以接收和发送多个VLAN的报文，可以用于交换机之间连接，也可以用于连接用户的计算机。
- Hybrid端口和Trunk端口在接收数据时，处理方法是一样的，唯一不同之处在于发送数据时：Hybrid端口可以允许多个VLAN的报文发送时不打标签，而Trunk端口只允许缺省VLAN的报文发送时不打标签。
- 在这里先要向大家阐明端口的缺省VLAN这个概念

## 1.3 缺省VLAN即“Pvid Vlan”“Native Vlan”

Access端口只属于1个VLAN，所以它的缺省VLAN就是它所在的VLAN，不用设置；    
Hybrid端口和Trunk端口属于多个VLAN，所以需要设置缺省VLAN ID。缺省情况下，Hybrid端口和Trunk端口的缺省VLAN为VLAN 1    
如果设置了端口的缺省VLAN ID，当端口接收到不带VLAN Tag的报文后，则将报文转发到属于缺省VLAN的端口；  当端口发送带有VLAN Tag的报文时，如果该报文的VLAN ID与端口缺省的VLAN ID相同，则系统将去掉报文的  VLAN Tag，然后再发送该报文。    
注：对于华为交换机缺省VLAN被称为“Pvid Vlan”， 对于思科交换机缺省VLAN被称为“Native Vlan”     

**ACCESS：PVID的Untagged Port; **   
​        接收时：如果是Untagged帧，按照PVID打上tag然后寻找相同VLAN ID的端口转发；如果是Tagged帧，丢弃；    
​        发送时：如果是Untagged帧，直接发出；如果是Tagged帧，VLAN ID等于PVID的话就去掉tag然后发出，否则丢弃；         

**TRUNK:多个VLAN ID（根据permit定义或GVRP学习）的Tagged Port和PVID的Untagged Port; **       

​       接收时：如果是Untagged帧，按照PVID打上tag然后寻找相同VLAN ID的端口转发；如果是Tagged帧，VLAN ID在Tagged Port有定义时直接寻找相同VLAN ID的端口转发，否则丢弃；     
​       发送时：如果是Untagged帧，按照PVID打上tag然后发出；如果是Tagged帧，VLAN ID在Tagged Port有定义时直接发出，否则丢弃；          

**HYBRID:任意VLAN ID的Tagged或Untagged Port，PVID的Untagged Port; **      
​       接收时：如果是Untagged帧，按照PVID打上tag然后寻找相同VLAN ID的端口转发；如果是Tagged帧，VLAN ID在Tagged Port有定义时直接寻找相同VLAN ID的端口转发，VLAN ID在Untagged Port有定义时去掉tag后寻找相同VLAN ID的端口转发，否则丢弃；     
​       发送时：如果是Untagged帧，按照PVID打上tag然后发出；如果是Tagged帧，VLAN ID在Tagged Port有定义时直接发出，VLAN ID在Untagged Port有定义时去掉tag后发出，否则丢弃；    