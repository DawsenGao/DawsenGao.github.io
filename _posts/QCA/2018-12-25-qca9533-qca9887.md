---
layout: post
title: QCA9533+QCA9887设备适配
description: QCA9533+QCA9887设备适配
category: QCA
---
最近手上搞到了一块设备QCA9533+QCA9887，查了一些相关资料，发现qca9887在新版本lede中已经支持，这样我就先从新版本lede开始。过程中肯定会遇到些问题，记录下解决过程。
在lede17版本中选择Qualcomm Atheros AP147-010 reference board,和ath10k驱动，由于我的设备和公板资源差不多，16M Flash和128M内存，基本不用修改什么，直接编译。

设备相关信息：
```
root@LEDE:/# cat /proc/cpuinfo 
system type             : Qualcomm Atheros QCA9533 ver 2 rev 0
machine                 : Atheros AP147-010 reference board
processor               : 0
cpu model               : MIPS 24Kc V7.4
BogoMIPS                : 432.53
wait instruction        : yes
microsecond timers      : yes
tlb_entries             : 16
extra interrupt vector  : yes
hardware watchpoint     : yes, count: 4, address/irw mask: [0x0ffc, 0x0ffc, 0x0ffb, 0x0ffb]
isa                     : mips1 mips2 mips32r1 mips32r2
ASEs implemented        : mips16
shadow register sets    : 1
kscratch registers      : 0
package                 : 0
core                    : 0
VCED exceptions         : not available
VCEI exceptions         : not available
```

启动出现错误，5G模块无法识别，通过ifconfig -a，看到只要2G的接口，没有5G的接口
```
[    9.441481] Loading modules backported from Linux version wt-2017-01-31-0-ge882dff19e7f
[    9.449817] Backport generated by backports.git backports-20160324-13-g24da7d3c
[    9.523494] PCI: Enabling device 0000:00:00.0 (0000 -> 0002)
[    9.529554] ath10k_pci 0000:00:00.0: pci irq legacy oper_irq_mode 1 irq_mode 0 reset_mode 0
[    9.743566] ath10k_pci 0000:00:00.0: Direct firmware load for ath10k/pre-cal-pci-0000:00:00.0.bin failed with error -2
[    9.754657] ath10k_pci 0000:00:00.0: Falling back to user helper
[    9.848894] firmware ath10k!pre-cal-pci-0000:00:00.0.bin: firmware_loading_store: map pages failed
[    9.858440] ath10k_pci 0000:00:00.0: Direct firmware load for ath10k/cal-pci-0000:00:00.0.bin failed with error -2
[    9.869159] ath10k_pci 0000:00:00.0: Falling back to user helper
[   10.049312] firmware ath10k!cal-pci-0000:00:00.0.bin: firmware_loading_store: map pages failed
[   10.058532] ath10k_pci 0000:00:00.0: Direct firmware load for ath10k/QCA9887/hw1.0/firmware-5.bin failed with error -2
[   10.069616] ath10k_pci 0000:00:00.0: Falling back to user helper
[   10.250804] firmware ath10k!QCA9887!hw1.0!firmware-5.bin: firmware_loading_store: map pages failed
[   10.260290] ath10k_pci 0000:00:00.0: could not fetch firmware file 'ath10k/QCA9887/hw1.0/firmware-5.bin': -11
[   10.270617] ath10k_pci 0000:00:00.0: Direct firmware load for ath10k/QCA9887/hw1.0/firmware-4.bin failed with error -2
[   10.281677] ath10k_pci 0000:00:00.0: Falling back to user helper
[   10.462077] firmware ath10k!QCA9887!hw1.0!firmware-4.bin: firmware_loading_store: map pages failed
[   10.471558] ath10k_pci 0000:00:00.0: could not fetch firmware file 'ath10k/QCA9887/hw1.0/firmware-4.bin': -11
[   10.481885] ath10k_pci 0000:00:00.0: Direct firmware load for ath10k/QCA9887/hw1.0/firmware-3.bin failed with error -2
[   10.492954] ath10k_pci 0000:00:00.0: Falling back to user helper
[   10.673528] firmware ath10k!QCA9887!hw1.0!firmware-3.bin: firmware_loading_store: map pages failed
[   10.683044] ath10k_pci 0000:00:00.0: could not fetch firmware file 'ath10k/QCA9887/hw1.0/firmware-3.bin': -11
[   10.693382] ath10k_pci 0000:00:00.0: Direct firmware load for ath10k/QCA9887/hw1.0/firmware-2.bin failed with error -2
[   10.704446] ath10k_pci 0000:00:00.0: Falling back to user helper
[   10.884678] firmware ath10k!QCA9887!hw1.0!firmware-2.bin: firmware_loading_store: map pages failed
[   10.894195] ath10k_pci 0000:00:00.0: could not fetch firmware file 'ath10k/QCA9887/hw1.0/firmware-2.bin': -11
[   10.904469] ath10k_pci 0000:00:00.0: could not fetch firmware files (-11)
[   10.911500] ath10k_pci 0000:00:00.0: could not probe fw (-11)
[   10.982215] ip_tables: (C) 2000-2006 Netfilter Core Team
[   10.998907] nf_conntrack version 0.5.0 (1959 buckets, 7836 max)
```

1.发现错误log中没有找到相关的firmware，查看了下设备的/lib/firmware/是空的，想起了还有firmware没有选择，make menuconfig-->Firmware--> ath10k-firmware-qca9887,重新编译烧写镜像，


2.启动后出现如下错误，但是，5G的接口已经有了，并且可以使用，相比之前firmware找不到问题解决了一部分。

```
[    9.680833] Loading modules backported from Linux version wt-2017-01-31-0-ge882dff19e7f
[    9.689103] Backport generated by backports.git backports-20160324-13-g24da7d3c
[    9.762423] PCI: Enabling device 0000:00:00.0 (0000 -> 0002)
[    9.768428] ath10k_pci 0000:00:00.0: pci irq legacy oper_irq_mode 1 irq_mode 0 reset_mode 0
[    9.983560] ath10k_pci 0000:00:00.0: Direct firmware load for ath10k/pre-cal-pci-0000:00:00.0.bin failed with error -2
[    9.994649] ath10k_pci 0000:00:00.0: Falling back to user helper
[   10.144723] firmware ath10k!pre-cal-pci-0000:00:00.0.bin: firmware_loading_store: map pages failed
[   10.154338] ath10k_pci 0000:00:00.0: Direct firmware load for ath10k/cal-pci-0000:00:00.0.bin failed with error -2
[   10.165072] ath10k_pci 0000:00:00.0: Falling back to user helper
[   10.345783] firmware ath10k!cal-pci-0000:00:00.0.bin: firmware_loading_store: map pages failed
[   10.573041] ath10k_pci 0000:00:00.0: qca9887 hw1.0 target 0x4100016d chip_id 0x004000ff sub 0000:0000
[   10.582636] ath10k_pci 0000:00:00.0: kconfig debug 0 debugfs 1 tracing 0 dfs 1 testmode 1
[   10.596516] ath10k_pci 0000:00:00.0: firmware ver 10.2.4-1.0-00013 api 5 features no-p2p,ignore-otp,skip-clock-init,mfp crc32 14a57ac6
[   10.649131] ath10k_pci 0000:00:00.0: board id is not exist in otp, ignore it
[   10.656556] ath10k_pci 0000:00:00.0: Direct firmware load for ath10k/QCA9887/hw1.0/board-2.bin failed with error -2
[   10.667357] ath10k_pci 0000:00:00.0: Falling back to user helper
[   10.761240] firmware ath10k!QCA9887!hw1.0!board-2.bin: firmware_loading_store: map pages failed
[   10.770762] ath10k_pci 0000:00:00.0: board_file api 1 bmi_id N/A crc32 546cca0d
[   13.287969] ath10k_pci 0000:00:00.0: htt-ver 2.1 wmi-op 5 htt-op 2 cal eeprom max-sta 128 raw 0 hwcrypto 1
[   13.524850] ip_tables: (C) 2000-2006 Netfilter Core Team
[   13.538769] nf_conntrack version 0.5.0 (1959 buckets, 7836 max)
```

3.解决上面错误：
```
duke@duke:~/share/lede/openwrt$ git diff package/firmware/ath10k-firmware/Makefile
diff --git a/package/firmware/ath10k-firmware/Makefile b/package/firmware/ath10k-firmware/Makefile
index 8bf5729..e28bb2e 100644
--- a/package/firmware/ath10k-firmware/Makefile
+++ b/package/firmware/ath10k-firmware/Makefile
@@ -238,6 +238,12 @@ define Package/ath10k-firmware-qca9887/install
        $(INSTALL_DATA) \
                $(DL_DIR)/$(QCA9887_BOARD_FILE_DL) \
                $(1)/lib/firmware/ath10k/QCA9887/hw1.0/board.bin
+       $(INSTALL_DATA) \
+               $(DL_DIR)/$(QCA9887_BOARD_FILE_DL) \
+               $(1)/lib/firmware/ath10k/QCA9887/hw1.0/board-2.bin
+       ln -s \
+               /lib/firmware/ath10k/QCA9887/hw1.0/board-2.bin \
+               $(1)/lib/firmware/ath10k/pre-cal-pci-0000:00:00.0.bin
 endef
 
```



